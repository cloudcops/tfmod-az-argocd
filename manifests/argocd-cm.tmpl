---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-cm
  namespace: argocd
data:
  kustomize.buildOptions: --enable-helm
  url: https://${ url }
  oidc.config: |
    name: ${ name }
    issuer: ${ endpoint }
    clientID: ${ client_id }
    clientSecret: "$oidc.auth0.clientSecret"
    skipAudienceCheckWhenTokenHasNoAudience: true
    requestedScopes: [%{ for scope in requested_scopes ~} "${scope}",%{ endfor ~}]
    requestedIDTokenClaims:
      groups:
        essential: true
  timeout.hard.reconciliation: 0s
  timeout.reconciliation: 180s
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: argocd-cmd-params-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-cmd-params-cm
  namespace: argocd
data:
  server.insecure: "true"
  server.log.level: ${ log_level }
  controller.log.level: ${ log_level }
  applicationsetcontroller.log.level: ${ log_level }
  notificationscontroller.log.level: ${ log_level }
  reposerver.log.level: ${ log_level }
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.github: |
    appID: ${ github_app_id }
    installationID: ${ github_installation_id }
    privateKey: $github-privateKey
  trigger.on-deployed: |
    - description: Application is synced and healthy. Triggered once per commit.
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-deployed
      when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded']
        and app.status.health.status == 'Healthy'
  template.app-deployed: |
    message: |
      Application {{.app.metadata.name}} finished sync {{ default "Unknown" .app.status.sync.status }} with health {{ default "Unknown" .app.status.health.status }}.
    github:
      repoURLPath: "{{.app.spec.source.repoURL}}"
      revisionPath: "{{.app.status.operationState.syncResult.revision}}"
      status:
        state: {{ if and (eq .app.status.sync.status "Synced") (eq .app.status.health.status "Healthy") }}success{{ else }}pending{{ end }}
        label: "{{ .app.metadata.name }}"
        targetURL: "https://${ url }/applications/{{.app.metadata.name}}?operation=true"
      deployment:
        state: {{ if and (eq .app.status.sync.status "Synced") (eq .app.status.health.status "Healthy") }}success{{ else }}failure{{ end }}
        environment: "${ argocd_environment }"
        environmentURL: "${ argocd_notification_url_for_github }"
        logURL: "https://${ url }/applications/{{.app.metadata.name}}?operation=true"
        requiredContexts: []
        autoMerge: true
        transientEnvironment: false
      pullRequestComment:
        content: |
          :wave: @myperfectstay/developers @myperfectstay/devops

          :tada: **Deployment Status:**
          Application `{{ .app.metadata.name }}` is **{{ default "Unknown" .app.status.sync.status }}** with health **{{ default "Unknown" .app.status.health.status }}**.

          {{- $apps := dict "items" (list) -}}
          {{- range $res := .app.status.resources }}
          {{- if eq $res.kind "Application" -}}
          {{- $_ := set $apps "items" (append (index $apps "items") $res) }}
          {{- end -}}
          {{- end -}}

          {{- if gt (len (index $apps "items")) 0 }}
          ### :package: Application Overview
          | Application | Sync Status | Health | Link |
          |-------------|-------------|--------|------|
          {{- range $item := (index $apps "items") }}
          | `{{$item.name}}` | {{$item.status}} | {{ if $item.health }}{{$item.health.status}}{{ else }}Unknown{{ end }} | [Open in Argo](https://${ url }/applications/{{$item.name}}) |
          {{- end }}
          {{- end }}

          ---

          :link: **Quick Access:**
          - [ArgoCD Operations for `{{ .app.metadata.name }}`](https://${ url }/applications/{{.app.metadata.name}}?operation=true)

          ---

          :robot: *Automated notification via ArgoCD*
