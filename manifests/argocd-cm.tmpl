---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-cm
  namespace: argocd
data:
  kustomize.buildOptions: --enable-helm
  url: https://${ url }
  oidc.config: |
    name: ${ name }
    issuer: ${ endpoint }
    clientID: ${ client_id }
    clientSecret: "$oidc.auth0.clientSecret"
    skipAudienceCheckWhenTokenHasNoAudience: true
    requestedScopes: [%{ for scope in requested_scopes ~} "${scope}",%{ endfor ~}]
    requestedIDTokenClaims:
      groups:
        essential: true
  resource.customizations: |
    argoproj.io/Application:
      health.lua: |
        hs = {}
        hs.status = "Progressing"
        hs.message = ""
        if obj.status ~= nil then
          if obj.status.health ~= nil then
            hs.status = obj.status.health.status
            if obj.status.health.message ~= nil then
              hs.message = obj.status.health.message
            end
          end
        end
        return hs
    batch/Job:
      health.lua: |
        hs = {}
        if obj.metadata.name == "viator-full-sync" then
            hs.status = "Healthy"
            hs.message = "Custom override: treating viator-full-sync as healthy"
            return hs
        end
        if obj.status ~= nil then
            if obj.status.succeeded ~= nil and obj.status.succeeded >= 1 then
            hs.status = "Healthy"
            hs.message = "Job completed successfully"
            elseif obj.status.failed ~= nil and obj.status.failed > 0 then
            hs.status = "Degraded"
            hs.message = "Job has failed"
            else
            hs.status = "Progressing"
            hs.message = "Job is running"
            end
        else
            hs.status = "Progressing"
            hs.message = "Waiting for job status"
        end
        return hs
  timeout.hard.reconciliation: 0s
  timeout.reconciliation: 180s    
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: argocd-cmd-params-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-cmd-params-cm
  namespace: argocd
data:
  server.insecure: "true"
  server.log.level: ${ log_level }
  controller.log.level: ${ log_level }
  applicationsetcontroller.log.level: ${ log_level }
  notificationscontroller.log.level: ${ log_level }
  reposerver.log.level: ${ log_level }
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.github: |
    appID: ${ github_app_id }
    installationID: ${ github_installation_id }
    privateKey: $github-privateKey
  trigger.on-deployed: |
    - description: Application is synced and healthy. Triggered once per commit.
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-deployed
      when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded']
        and app.status.health.status == 'Healthy'
  template.app-deployed: |
    message: |
      All Applications of {{.app.metadata.name}} are synced and healthy.
    github:
      repoURLPath: "{{.app.spec.source.repoURL}}"
      revisionPath: "{{.app.status.operationState.syncResult.revision}}"
      status:
        state: success
        label: "${ argocd_path }"
        targetURL: "https://${ url }/applications/{{.app.metadata.name}}?operation=true"
      deployment:
        state: success
        environment: "${ argocd_environment }"
        environmentURL: "${ argocd_notification_url_for_github }"
        logURL: "https://${ url }/applications/{{.app.metadata.name}}?operation=true"
        requiredContexts: []
        autoMerge: true
        transientEnvironment: false
      pullRequestComment:
        content: |
          :wave: @myperfectstay/developers @myperfectstay/devops

          :tada: **Deployment Status:**
          Your deployment for `Application` `{{.app.metadata.name}}` was successful! :rocket:

          All related applications are **synced** and **healthy**. :white_check_mark:

          ### :package: MPS Backend Applications Overview
          | Application         | Status                        | Link                                                                            |
          |---------------------|-------------------------------|---------------------------------------------------------------------------------|
          | `app-of-apps`       | ✔ {{.app.status.sync.status}} | [Go to Operations](https://${ url }/applications/{{.app.metadata.name}}?operation=true) |
          | `mps-core`          | ✔ {{.app.status.sync.status}} | [Go to Application](https://${ url }/applications/mps-core)                             |
          | `mps-celery-beat`   | ✔ {{.app.status.sync.status}} | [Go to Application](https://${ url }/applications/mps-celery-beat)                      |
          | `mps-celery-worker` | ✔ {{.app.status.sync.status}} | [Go to Application](https://${ url }/applications/mps-celery-worker)                    |

          ---

          :link: **Quick Access:**
          - [MPS backend API docs](${ argocd_notification_url_for_github })
          - [ArgoCD Operations for `app-of-apps`](https://${ url }/applications/{{.app.metadata.name}}?operation=true)

          ---

          :robot: *Automated notification via ArgoCD*
